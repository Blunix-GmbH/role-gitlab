---
- name: Converge
  hosts: all
  gather_facts: False
  tasks:
    - name: Install python for Ansible
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      become: True
      changed_when: False

- name: Converge
  hosts: all
  become: yes
  vars:
    # There is no repo for xenial but the stretch repo seems to work..
    # Overriding this var here for usage in templates/etc/apt/sources.list.d/gitlab_gitlab-ce.list
    gitlab_ansible_distribution_release: stretch
    gitlab_external_url: "https://{{ ansible_hostname }}"
    gitlab_email_enabled: "true"
    gitlab_email_from: "noreply@{{ ansible_hostname }}"
    gitlab_email_display_name: "noreply@{{ ansible_hostname }}"
    gitlab_email_reply_to: "monitoring@example.com"
    gitlab_nginx_ssl_certificate: /etc/ssl/certs/snakeoil.crt
    gitlab_nginx_ssl_certificate_key: /etc/ssl/private/snakeoil.key
    # This role will update the initial gitlab "root" user password
    gitlab_root_user_password: secretpassword
    gitlab_root_user_email: "monitoring@example.com"
    # Disable ssl cert validation for molecule runs (use self signed)
    gitlab_api_calls_validate_certs: False

    # optional LDAP
    gitlab_use_ldap: False
    gitlab_ldap_host: ldap-host
    gitlab_ldap_port: 389
    gitlab_ldap_uid: uid
    gitlab_ldap_bind_dn: cn=gitlab,ou=users,dc=example,dc=com
    gitlab_ldap_password: "secretpassword"
    gitlab_ldap_encryption: plain
    # Note the quotes around the booleans - gitlab.yml requires the _string_ "true" or "false"
    gitlab_ldap_verify_certificates: "true"
    gitlab_ldap_active_directory: "true"
    gitlab_ldap_allow_username_or_email_login: "false"
    gitlab_ldap_lowercase_usernames: "false"
    gitlab_ldap_block_auto_created_users: "false"
    gitlab_ldap_base: ou=users,dc=example,dc=com
    gitlab_ldap_user_filter: (objectClass=posixAccount)

  pre_tasks:

    # Prepare a snakeoil cert for gitlab to use
    # only required in molecule
    - name: install python-openssl
      apt:
        name: python-openssl
        state: present

    - name: generate an openssl private key
      openssl_privatekey:
        path: /etc/ssl/private/snakeoil.key

    - name: generate an openssl certificate signing request
      openssl_csr:
        path: /etc/ssl/private/snakeoil.csr
        privatekey_path: /etc/ssl/private/snakeoil.key
        common_name: "snakeoil"

    - name: generate an openssl self signed certificate
      openssl_certificate:
        path: /etc/ssl/certs/snakeoil.crt
        privatekey_path: /etc/ssl/private/snakeoil.key
        csr_path: /etc/ssl/private/snakeoil.csr
        provider: selfsigned

  roles:
    - role: role-gitlab
